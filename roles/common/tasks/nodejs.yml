- name:  Configure YUM repos
  ansible.builtin.shell:  curl -sL https://rpm.nodesource.com/setup_lts.x | bash

- name:  Install NodeJs
  ansible.builtin.yum:
    name:
      - nodejs
      - gcc-c++
    state:  installed

- name: Add Roboshop user
  ansible.builtin.user:
    name: roboshop
    comment:  Roboshop application user

- name:  Download and Extract {{COMPONENT}} content
  include_role:
    name:  common
    tasks_from:  download

- name:  Clean up old content
  ansible.builtin.file:
    path:  /home/roboshop/{{COMPONENT}}
    state:  absent

- name:  Copy content
  ansible.builtin.copy:
    src:  /tmp/{{COMPONENT}}-main/
    dest:  /home/roboshop/{{COMPONENT}}/
    remote_src:  yes


- name:  Install NodeJs dependencies.
  community.general.npm:
    path:  /home/roboshop/{{COMPONENT}}

# - name:  Replace MONGO_DNSNAME in the systemd configuration file
#   ansible.builtin.replace:
#     path:  /home/roboshop/catalogue/systemd.service
#     regexp:  'MONGO_DNSNAME'
#     replace:  'mongodb.roboshop.internal'

- name:  Copy SystemD file
  ansible.builtin.copy:
    src:  systemd.service
    dest:  /etc/systemd/system/{{COMPONENT}}.service
    remote_src:  yes

- name:  Enable and Start {{COMPONENT}} service
  ansible.builtin.systemd:
    name:  "{{COMPONENT}}"
    state:  restarted
    enabled:  yes
    daemon-reload:  yes
